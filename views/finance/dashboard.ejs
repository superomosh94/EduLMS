<%- include('../../layouts/finance-layout', {
    title: 'Finance Dashboard - EduLMS',
    pageTitle: 'Finance Dashboard',
    currentPage: 'dashboard',
    breadcrumbs: [
        { title: 'Finance', url: '/finance/dashboard', active: true }
    ]
}) %>

<div class="row">
    <!-- Revenue Overview -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Revenue Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-primary">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <h3>$<%= revenue.today || '0' %></h3>
                                <p>Today's Collection</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-success">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                            <div class="stat-content">
                                <h3>$<%= revenue.week || '0' %></h3>
                                <p>This Week</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-info">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3>$<%= revenue.month || '0' %></h3>
                                <p>This Month</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-warning">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="stat-content">
                                <h3>$<%= revenue.total || '0' %></h3>
                                <p>Total Revenue</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Statistics -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Payment Statistics
                </h5>
            </div>
            <div class="card-body">
                <canvas id="paymentChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/finance/invoices/generate" class="btn btn-primary">
                        <i class="fas fa-file-invoice me-2"></i>Generate Invoice
                    </a>
                    <a href="/finance/payments/pending" class="btn btn-warning">
                        <i class="fas fa-clock me-2"></i>Pending Payments (<%= pendingPayments %>)
                    </a>
                    <a href="/finance/students/outstanding" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Outstanding Fees
                    </a>
                    <a href="/finance/reports/financial" class="btn btn-info">
                        <i class="fas fa-chart-pie me-2"></i>Generate Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Payments -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Payments
                </h5>
                <a href="/finance/payments/records" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (recentPayments && recentPayments.length > 0) { %>
                                <% recentPayments.forEach(payment => { %>
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="<%= payment.student.user.avatar || '/images/avatars/default.png' %>" 
                                                     alt="<%= payment.student.user.firstName %>" 
                                                     class="rounded-circle me-2" width="32" height="32">
                                                <div>
                                                    <div class="fw-bold"><%= payment.student.user.firstName %> <%= payment.student.user.lastName %></div>
                                                    <small class="text-muted"><%= payment.student.studentId %></small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>$<%= payment.amount %></td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-<%= payment.paymentMethod === 'mpesa' ? 'mobile-alt' : 'credit-card' %> me-1"></i>
                                                <%= payment.paymentMethod.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-<%= getPaymentStatusBadge(payment.status) %>">
                                                <%= payment.status %>
                                            </span>
                                        </td>
                                        <td><%= formatDate(payment.paidAt) %></td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/finance/payments/<%= payment._id %>" class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <% if (payment.status === 'pending') { %>
                                                    <button class="btn btn-outline-success verify-payment" data-payment-id="<%= payment._id %>">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
                                        <p class="text-muted mb-0">No recent payments</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Outstanding Fees Summary -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Outstanding Fees
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <% if (outstandingFees && outstandingFees.length > 0) { %>
                        <% outstandingFees.slice(0, 5).forEach(student => { %>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><%= student.user.firstName %> <%= student.user.lastName %></h6>
                                        <small class="text-muted"><%= student.studentId %> â€¢ <%= student.program %></small>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-danger">$<%= student.feeBalance %></div>
                                        <small class="text-muted">Overdue</small>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <p class="text-muted mb-0">No outstanding fees</p>
                        </div>
                    <% } %>
                </div>
                <div class="mt-3">
                    <a href="/finance/students/outstanding" class="btn btn-outline-primary w-100">
                        View All Outstanding
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Methods Distribution -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Payment Methods
                </h5>
            </div>
            <div class="card-body">
                <canvas id="paymentMethodsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// Payment Statistics Chart
const paymentCtx = document.getElementById('paymentChart').getContext('2d');
const paymentChart = new Chart(paymentCtx, {
    type: 'line',
    data: {
        labels: <%= JSON.stringify(paymentStats.labels) %>,
        datasets: [{
            label: 'Daily Revenue',
            data: <%= JSON.stringify(paymentStats.revenue) %>,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value;
                    }
                }
            }
        }
    }
});

// Payment Methods Chart
const methodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
const methodsChart = new Chart(methodsCtx, {
    type: 'doughnut',
    data: {
        labels: <%= JSON.stringify(paymentMethods.labels) %>,
        datasets: [{
            data: <%= JSON.stringify(paymentMethods.data) %>,
            backgroundColor: [
                '#007bff',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#6c757d'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Verify Payment
document.querySelectorAll('.verify-payment').forEach(button => {
    button.addEventListener('click', function() {
        const paymentId = this.dataset.paymentId;
        if (confirm('Are you sure you want to verify this payment?')) {
            fetch(`/finance/payments/${paymentId}/verify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error verifying payment: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error verifying payment');
            });
        }
    });
});

function getPaymentStatusBadge(status) {
    const statusColors = {
        'completed': 'success',
        'pending': 'warning',
        'failed': 'danger',
        'cancelled': 'secondary'
    };
    return statusColors[status] || 'secondary';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}
</script>

<style>
.stat-card {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
}

.stat-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.stat-content h3 {
    margin: 0;
    color: #333;
}

.stat-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}
</style>