<%- include('../partials/admin-header') %>

<div class="container-fluid">
    <div class="row">
        <%- include('../partials/admin-sidebar') %>
        
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Notifications</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="/admin/notifications/create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Notification
                    </a>
                </div>
            </div>

            <%- include('../../partials/flash-messages') %>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="unread">Unread</option>
                                <option value="read">Read</option>
                                <option value="sent">Sent</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="type" class="form-label">Type</label>
                            <select class="form-select" id="type" name="type">
                                <option value="">All Types</option>
                                <option value="system">System</option>
                                <option value="academic">Academic</option>
                                <option value="financial">Financial</option>
                                <option value="announcement">Announcement</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="audience" class="form-label">Audience</label>
                            <select class="form-select" id="audience" name="audience">
                                <option value="">All Audiences</option>
                                <option value="all">All Users</option>
                                <option value="students">Students</option>
                                <option value="instructors">Instructors</option>
                                <option value="finance">Finance Officers</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                            <button type="reset" class="btn btn-outline-secondary">Reset</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Notifications Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">All Notifications</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="notificationsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Audience</th>
                                    <th>Status</th>
                                    <th>Sent Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (notifications && notifications.length > 0) { %>
                                    <% notifications.forEach(notification => { %>
                                        <tr class="<%= notification.status === 'unread' ? 'table-active' : '' %>">
                                            <td>
                                                <input type="checkbox" class="notification-check" value="<%= notification._id %>">
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <% if (notification.status === 'unread') { %>
                                                        <span class="badge bg-primary me-2">New</span>
                                                    <% } %>
                                                    <strong><%= notification.title %></strong>
                                                </div>
                                                <small class="text-muted"><%= notification.message.substring(0, 50) %>...</small>
                                            </td>
                                            <td>
                                                <span class="badge 
                                                    <%= notification.type === 'system' ? 'bg-danger' : '' %>
                                                    <%= notification.type === 'academic' ? 'bg-info' : '' %>
                                                    <%= notification.type === 'financial' ? 'bg-warning' : '' %>
                                                    <%= notification.type === 'announcement' ? 'bg-success' : '' %>">
                                                    <%= notification.type.charAt(0).toUpperCase() + notification.type.slice(1) %>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">
                                                    <%= notification.audience.charAt(0).toUpperCase() + notification.audience.slice(1) %>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge 
                                                    <%= notification.status === 'sent' ? 'bg-success' : '' %>
                                                    <%= notification.status === 'scheduled' ? 'bg-warning' : '' %>
                                                    <%= notification.status === 'read' ? 'bg-info' : '' %>
                                                    <%= notification.status === 'unread' ? 'bg-primary' : '' %>">
                                                    <%= notification.status.charAt(0).toUpperCase() + notification.status.slice(1) %>
                                                </span>
                                            </td>
                                            <td>
                                                <%= new Date(notification.createdAt).toLocaleDateString() %>
                                                <br>
                                                <small class="text-muted"><%= new Date(notification.createdAt).toLocaleTimeString() %></small>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="/admin/notifications/<%= notification._id %>" 
                                                       class="btn btn-sm btn-outline-primary" 
                                                       title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="/admin/notifications/<%= notification._id %>/edit" 
                                                       class="btn btn-sm btn-outline-secondary" 
                                                       title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-danger delete-notification" 
                                                            data-id="<%= notification._id %>"
                                                            title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="fas fa-bell fa-3x mb-3"></i>
                                                <p>No notifications found</p>
                                            </div>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="mt-3" id="bulkActions" style="display: none;">
                        <div class="d-flex align-items-center">
                            <span class="me-3" id="selectedCount">0 notifications selected</span>
                            <select class="form-select me-2" style="width: auto;" id="bulkAction">
                                <option value="">Choose action...</option>
                                <option value="mark_read">Mark as Read</option>
                                <option value="mark_unread">Mark as Unread</option>
                                <option value="delete">Delete</option>
                            </select>
                            <button class="btn btn-primary" id="applyBulkAction">Apply</button>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <% if (pagination && pagination.totalPages > 1) { %>
                        <%- include('../../partials/pagination', {pagination: pagination}) %>
                    <% } %>
                </div>
            </div>
        </main>
    </div>
</div>

<%- include('../partials/admin-footer') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select All functionality
    const selectAll = document.getElementById('selectAll');
    const notificationChecks = document.querySelectorAll('.notification-check');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const bulkAction = document.getElementById('bulkAction');
    const applyBulkAction = document.getElementById('applyBulkAction');

    selectAll.addEventListener('change', function() {
        notificationChecks.forEach(check => {
            check.checked = this.checked;
        });
        updateBulkActions();
    });

    notificationChecks.forEach(check => {
        check.addEventListener('change', updateBulkActions);
    });

    function updateBulkActions() {
        const selected = document.querySelectorAll('.notification-check:checked');
        selectedCount.textContent = `${selected.length} notification${selected.length !== 1 ? 's' : ''} selected`;
        bulkActions.style.display = selected.length > 0 ? 'block' : 'none';
    }

    // Bulk actions
    applyBulkAction.addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.notification-check:checked'))
            .map(check => check.value);
        const action = bulkAction.value;

        if (!action) {
            alert('Please select an action');
            return;
        }

        if (confirm(`Are you sure you want to ${action.replace('_', ' ')} ${selectedIds.length} notification(s)?`)) {
            fetch('/admin/notifications/bulk-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: action,
                    notificationIds: selectedIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error performing bulk action');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error performing bulk action');
            });
        }
    });

    // Delete notification
    document.querySelectorAll('.delete-notification').forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this notification?')) {
                fetch(`/admin/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting notification');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting notification');
                });
            }
        });
    });

    // Filter form submission
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        window.location.href = `/admin/notifications?${params.toString()}`;
    });
});
</script>